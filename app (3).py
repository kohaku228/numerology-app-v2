mport streamlit as st
import datetime
import locale
import base64
from fpdf import FPDF
import tempfile
from collections import Counter

# 日本語ロケール設定（ただしStreamlitのdate_inputでは効かない可能性あり）
try:
    locale.setlocale(locale.LC_TIME, 'ja_JP.UTF-8')
except:
    pass

# ピタゴラス変換表
def char_to_num(c):
    mapping = {
        'A':1, 'J':1, 'S':1,
        'B':2, 'K':2, 'T':2,
        'C':3, 'L':3, 'U':3,
        'D':4, 'M':4, 'V':4,
        'E':5, 'N':5, 'W':5,
        'F':6, 'O':6, 'X':6,
        'G':7, 'P':7, 'Y':7,
        'H':8, 'Q':8, 'Z':8,
        'I':9, 'R':9
    }
    return mapping.get(c.upper(), 0)

def reduce_number(n):
    while n > 9 and n not in [11, 22, 33]:
        n = sum(int(d) for d in str(n))
    return n

def calculate_life_path_number(birthdate):
    digits = [int(d) for d in birthdate.replace('-', '') if d.isdigit()]
    return reduce_number(sum(digits))

def calculate_birth_day_number(day):
    return reduce_number(day)

def calculate_expression_number(name):
    return reduce_number(sum(char_to_num(c) for c in name if c.isalpha()))

def calculate_soul_urge_number(name):
    vowels = "AEIOU"
    return reduce_number(sum(char_to_num(c) for c in name if c.upper() in vowels))

# 数字の意味の解説辞書（役割別）
def get_number_meaning(position, n):
    meanings = {
        "life_path": {
            1: "あなたの人生は『自立』と『リーダーシップ』がテーマです。先頭に立って新しい道を切り開く運命にあります。",
            2: "あなたの人生は『調和』と『共感』がテーマです。人との関わりを通じて、優しさと受容の力を育みます。",
            3: "あなたの人生は『表現』と『創造性』がテーマです。楽しさを分かち合い、周囲に喜びを届ける存在です。",
            4: "あなたの人生は『安定』と『継続』がテーマです。地道な努力と信頼で、着実に基盤を築いていきます。",
            5: "あなたの人生は『自由』と『変化』がテーマです。新しい挑戦や刺激を求めて進むことで、道が開かれていくでしょう。",
            6: "あなたの人生は『愛』と『責任』がテーマです。家族や仲間を支え、安心と調和を広げていきます。",
            7: "あなたの人生は『探究』と『精神性』がテーマです。静けさの中で深い洞察を得て、真実を追い求めます。",
            8: "あなたの人生は『達成』と『現実的な成功』がテーマです。実行力と戦略的思考で目標を現実化していきます。",
            9: "あなたの人生は『奉仕』と『理想』がテーマです。広い視野で人や社会に貢献する使命があります。",
            11: "あなたの人生は『直感』と『インスピレーション』がテーマです。高次の気づきを伝えるスピリチュアルな導き手です。",
            22: "あなたの人生は『理想の具現化』がテーマです。大きなビジョンを現実に落とし込む使命があります。",
            33: "あなたの人生は『無条件の愛』がテーマです。周囲に愛と癒しを届ける教師的な存在です。"
        },
        "birth_day": {
            1: "強い意思と自己主張を持ち、リーダー的な素質を備えています。",
            2: "協調性があり、人との調和を大切にする性格です。",
            3: "明るく社交的で、表現力豊かに人を惹きつけます。",
            4: "責任感が強く、コツコツ努力できる信頼の人です。",
            5: "柔軟性や好奇心に富み、変化に強い力を持っています。",
            6: "愛情深く、周囲への思いやりにあふれた存在です。",
            7: "内省的で精神性が高く、一人の時間を大切にします。",
            8: "現実的な視点と実行力を持ち、成功を追求します。",
            9: "優しさと理想を持ち、周囲への奉仕精神にあふれています。",
            11: "鋭い直感力とインスピレーションに恵まれています。",
            22: "大きな夢を現実化する力を持つ実践的理想主義者です。",
            33: "深い愛と奉仕の心で人々を癒す存在です。"
        },
        "expression": {
            1: "周囲からは『リーダー』として見られることが多いです。行動力と決断力に優れています。",
            2: "繊細で調整力があり、仲介役として重宝される存在です。",
            3: "楽しい人、表現力豊かな人として明るい印象を与えます。",
            4: "真面目でしっかり者という信頼感を持たれます。",
            5: "自由な発想を持つ人として見られることが多く、軽やかに新しい風を運ぶ存在です。",
            6: "面倒見が良く、優しさと思いやりに満ちた印象です。",
            7: "知的でミステリアスな雰囲気があり、一目置かれやすいです。",
            8: "ビジネスセンスや実行力を感じさせる人物として見られます。",
            9: "包容力と理想主義を持った精神的リーダーとして映ります。",
            11: "感性が鋭く、独自のセンスを持った人として見られます。",
            22: "現実的でありながら理想を追求する大きな器の人物像です。",
            33: "愛にあふれたカリスマ的存在として、周囲に癒しを与えます。"
        },
        "soul": {
            1: "自立して生きたいという強い意志を内に秘めています。",
            2: "人と深くつながり、理解し合いたいという願いを持っています。",
            3: "喜びや楽しさを分かち合いたいという願望があります。",
            4: "安心できる土台と安定を求める気持ちが強いです。",
            5: "変化し続けること、自由でいることを心の奥で強く望んでいます。",
            6: "誰かを支え、愛し、守りたいという深い欲求を持っています。",
            7: "精神的な充足や真理を探究したいという欲求があります。",
            8: "成功したい、影響力を持ちたいという意欲が根底にあります。",
            9: "人の役に立ちたい、社会に貢献したいという魂の願いがあります。",
            11: "スピリチュアルな成長や啓示を求める魂の欲求があります。",
            22: "理想を形にしたい、スケールの大きな目標を実現したいという衝動があります。",
            33: "見返りのない愛を与えたい、癒したいという深い愛の動機があります。"
        },
    }
    return meanings.get(position, {}).get(n, "この数と役割の組み合わせの意味はまだ用意されていません。")

